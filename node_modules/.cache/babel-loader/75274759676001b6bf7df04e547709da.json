{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\nexports.getFundedTxBuilder = exports.createUnfundedCurrencyTransfer = exports.validateFundedCurrencyTransfer = exports.unpackOutput = void 0;\nvar verus_typescript_primitives_1 = require(\"verus-typescript-primitives\");\nvar bn_js_1 = require(\"bn.js\");\nvar Transaction = require('./transaction.js');\nvar TransactionBuilder = require('./transaction_builder.js');\nvar TxDestination = require('./tx_destination.js');\nvar script = require('./script.js');\nvar opcodes = require('bitcoin-ops');\nvar OptCCParams = require('./optccparams');\nvar templates = require('./templates');\n// Hack to force BigNumber to get typeof class instead of BN namespace\nvar BNClass = new bn_js_1.BN(0);\nvar unpackOutput = function (output, systemId, isInput, allowNonTransferEvals) {\n  var _a, _b;\n  if (isInput === void 0) {\n    isInput = false;\n  }\n  if (allowNonTransferEvals === void 0) {\n    allowNonTransferEvals = false;\n  }\n  // Verify change output\n  var outputScript = output.script;\n  var outputType = templates.classifyOutput(outputScript);\n  var values = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n  var fees = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n  var destinations = [];\n  var master;\n  var params = [];\n  if (outputType === templates.types.P2PK && isInput) {\n    values[systemId] = values[systemId].add(new bn_js_1.BN(output.value));\n  } else if (outputType === templates.types.P2PKH) {\n    var destAddr = verus_typescript_primitives_1.toBase58Check(templates.pubKeyHash.output.decode(outputScript), 60);\n    values[systemId] = values[systemId].add(new bn_js_1.BN(output.value));\n    destinations.push(destAddr);\n  } else if (outputType === templates.types.SMART_TRANSACTION) {\n    var masterOptCC = void 0;\n    var paramsOptCC = [];\n    var decompiledScript = script.decompile(outputScript);\n    for (var i = 0; i < decompiledScript.length; i += 2) {\n      if (i === 0) masterOptCC = OptCCParams.fromChunk(decompiledScript[i]);else paramsOptCC.push(OptCCParams.fromChunk(decompiledScript[i]));\n    }\n    if (paramsOptCC.length > 1) throw new Error(\">1 OptCCParam objects not currently supported for smart transaction params.\");\n    var processDestination_1 = function (destination) {\n      if (!(destination.destType === 1 && isInput) && destination.destType !== 2 && destination.destType !== 4) {\n        throw new Error(\"Unsupported destination type\");\n      }\n      var destAddr = verus_typescript_primitives_1.toBase58Check(destination.destinationBytes, destination.destType === 2 ? 60 : 102);\n      if (!destinations.includes(destAddr)) {\n        destinations.push(destAddr);\n      }\n    };\n    var processOptCCParam = function (ccparam) {\n      var _a, _b;\n      var data;\n      var ccvalues = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n      var ccfees = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n      switch (ccparam.evalCode) {\n        case verus_typescript_primitives_1.EVALS.EVAL_NONE:\n          if (ccparam.vData.length !== 0) {\n            throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n          }\n          ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n          break;\n        case verus_typescript_primitives_1.EVALS.EVAL_STAKEGUARD:\n          if (!isInput) {\n            throw new Error(\"Cannot create stakeguard output.\");\n          }\n          ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n          break;\n        case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_TRANSFER:\n          if (ccparam.vData.length !== 1) {\n            throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n          }\n          var resTransfer = new verus_typescript_primitives_1.ReserveTransfer();\n          resTransfer.fromBuffer(ccparam.vData[0]);\n          ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n          resTransfer.reserve_values.value_map.forEach(function (value, key) {\n            if (key !== systemId) {\n              if (!ccvalues[key]) ccvalues[key] = value;else ccvalues[key] = ccvalues[key].add(value);\n            }\n          });\n          data = resTransfer;\n          var fee = resTransfer.fee_amount;\n          var feecurrency = resTransfer.fee_currency_id;\n          ccfees[feecurrency] = fee;\n          if (resTransfer.transfer_destination.fees != null) {\n            ccfees[feecurrency] = ccfees[feecurrency].add(resTransfer.transfer_destination.fees);\n          }\n          for (var _i = 0, _c = resTransfer.transfer_destination.aux_dests; _i < _c.length; _i++) {\n            var aux_dest = _c[_i];\n            if (aux_dest.hasAuxDests()) {\n              throw new Error(\"Nested aux destinations not supported\");\n            }\n            if (aux_dest.fees != null) {\n              ccfees[feecurrency] = ccfees[feecurrency].add(aux_dest.fees);\n            }\n            processDestination_1({\n              destType: aux_dest.typeNoFlags().toNumber(),\n              destinationBytes: aux_dest.destination_bytes\n            });\n          }\n          break;\n        case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT:\n          if (ccparam.vData.length !== 1) {\n            throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n          }\n          var resOutput = new verus_typescript_primitives_1.TokenOutput();\n          resOutput.fromBuffer(ccparam.vData[0]);\n          ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n          resOutput.reserve_values.value_map.forEach(function (value, key) {\n            if (key !== systemId) {\n              if (!ccvalues[key]) ccvalues[key] = value;else ccvalues[key] = ccvalues[key].add(value);\n            }\n          });\n          data = resOutput;\n          break;\n        case verus_typescript_primitives_1.EVALS.EVAL_IDENTITY_PRIMARY:\n          if (allowNonTransferEvals) {\n            ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n            var id = new verus_typescript_primitives_1.Identity();\n            id.fromBuffer(ccparam.vData[0]);\n            data = id;\n          } else {\n            throw new Error('EVAL_IDENTITY_PRIMARY not permitted in this context.');\n          }\n          break;\n        default:\n          throw new Error(\"Unsupported eval code \" + ccparam.evalCode);\n      }\n      return {\n        version: ccparam.version,\n        eval: ccparam.evalCode,\n        m: ccparam.m,\n        n: ccparam.n,\n        data: data,\n        values: ccvalues,\n        fees: ccfees\n      };\n    };\n    master = processOptCCParam(masterOptCC);\n    for (var _i = 0, _c = masterOptCC.destinations; _i < _c.length; _i++) {\n      var destination = _c[_i];\n      processDestination_1(destination);\n    }\n    for (var _d = 0, paramsOptCC_1 = paramsOptCC; _d < paramsOptCC_1.length; _d++) {\n      var paramsCc = paramsOptCC_1[_d];\n      var processedParams = processOptCCParam(paramsCc);\n      params.push(processedParams);\n      for (var key in processedParams.values) {\n        var value = processedParams.values[key];\n        if (!values[key]) values[key] = value;else values[key] = values[key].add(value);\n      }\n      for (var key in processedParams.fees) {\n        var fee = processedParams.fees[key];\n        if (!fees[key]) fees[key] = fee;else fees[key] = fees[key].add(fee);\n      }\n      for (var _e = 0, _f = paramsCc.destinations; _e < _f.length; _e++) {\n        var destination = _f[_e];\n        processDestination_1(destination);\n      }\n    }\n  } else {\n    throw new Error(\"Unsupported output type \" + outputType);\n  }\n  return {\n    destinations: destinations,\n    values: values,\n    fees: fees,\n    type: outputType,\n    master: master,\n    params: params.length > 0 ? params : undefined\n  };\n};\nexports.unpackOutput = unpackOutput;\nvar validateFundedCurrencyTransfer = function (systemId, fundedTxHex, unfundedTxHex, changeAddr, network, utxoList) {\n  var _a, _b, _c, _d;\n  var amountsIn = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n  var amountsOut = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n  var amountChange = (_c = {}, _c[systemId] = new bn_js_1.BN(0), _c);\n  var amountsFee = (_d = {}, _d[systemId] = new bn_js_1.BN(0), _d);\n  var fundedTx = Transaction.fromHex(fundedTxHex, network);\n  var unfundedTx = Transaction.fromHex(unfundedTxHex, network);\n  var fundedTxComparison = Transaction.fromHex(fundedTxHex, network);\n  if (!fundedTxComparison.ins.length) {\n    return {\n      valid: false,\n      message: \"Transaction has \" + fundedTxComparison.ins.length + \" inputs.\"\n    };\n  }\n  fundedTxComparison.ins = [];\n  fundedTx.outs = fundedTx.outs;\n  unfundedTx.outs = unfundedTx.outs;\n  fundedTxComparison.outs = fundedTxComparison.outs;\n  fundedTx.ins = fundedTx.ins;\n  unfundedTx.ins = unfundedTx.ins;\n  fundedTxComparison.ins = fundedTxComparison.ins;\n  var changeOutputs = [];\n  var changeIndices = [];\n  if (!fundedTxComparison.outs.length) {\n    return {\n      valid: false,\n      message: \"Transaction has \" + fundedTxComparison.outs.length + \" outputs.\"\n    };\n  }\n  // Find all change outputs\n  for (var i = 0, j = 0; i < fundedTxComparison.outs.length; i++, j++) {\n    var out = fundedTxComparison.outs[i];\n    var outScript = out.script.toString('hex');\n    if (unfundedTx.outs[j] != null && outScript === unfundedTx.outs[j].script.toString('hex') && out.value === unfundedTx.outs[j].value) {\n      continue;\n    } else {\n      changeOutputs.push(out);\n      changeIndices.push(i);\n      j--;\n    }\n  }\n  // Filter change outputs from tx comparison\n  fundedTxComparison.outs = fundedTxComparison.outs.filter(function (x, i) {\n    return !changeIndices.includes(i);\n  });\n  // Verify funded tx and unfunded tx are the same where \n  // they should be the same\n  if (fundedTxComparison.toHex() !== unfundedTx.toHex()) {\n    return {\n      valid: false,\n      message: \"Transaction hex does not match unfunded component.\"\n    };\n  }\n  var _loop_1 = function (input) {\n    var inputHash = Buffer.from(input.hash).reverse().toString('hex');\n    var inputUtxoIndex = utxoList.findIndex(function (x) {\n      return x.txid === inputHash && x.outputIndex === input.index;\n    });\n    if (inputUtxoIndex < 0) {\n      return {\n        value: {\n          valid: false,\n          message: \"Cannot find corresponding input for \" + inputHash + \" index \" + input.index + \".\"\n        }\n      };\n    }\n    var inputUtxo = utxoList[inputUtxoIndex];\n    var _script = Buffer.from(inputUtxo.script, 'hex');\n    var _value = inputUtxo.satoshis;\n    try {\n      var inputInfo = exports.unpackOutput({\n        value: _value,\n        script: _script\n      }, systemId, true);\n      for (var key in inputInfo.values) {\n        if (amountsIn[key] == null) {\n          amountsIn[key] = new bn_js_1.BN(inputInfo.values[key] != null ? inputInfo.values[key] : 0);\n        } else amountsIn[key] = amountsIn[key].add(inputInfo.values[key]);\n      }\n    } catch (e) {\n      return {\n        value: {\n          valid: false,\n          message: e.message\n        }\n      };\n    }\n  };\n  // Verify all inputs are correct and count their amounts\n  for (var _i = 0, _e = fundedTx.ins; _i < _e.length; _i++) {\n    var input = _e[_i];\n    var state_1 = _loop_1(input);\n    if (typeof state_1 === \"object\") return state_1.value;\n  }\n  // Count output amounts (trusted more than input because we verify that they match\n  // the outputs submitted in the unfunded transaction)\n  for (var i = 0; i < unfundedTx.outs.length; i++) {\n    var output = unfundedTx.outs[i];\n    try {\n      var outputInfo = exports.unpackOutput(output, systemId, false, true);\n      for (var key in outputInfo.values) {\n        if (amountsOut[key] == null) {\n          amountsOut[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);\n        } else amountsOut[key] = amountsOut[key].add(outputInfo.values[key]);\n      }\n      for (var key in outputInfo.fees) {\n        if (amountsFee[key] == null) {\n          amountsFee[key] = new bn_js_1.BN(outputInfo.fees[key] != null ? outputInfo.fees[key] : 0);\n        } else amountsFee[key] = amountsFee[key].add(outputInfo.fees[key]);\n      }\n    } catch (e) {\n      return {\n        valid: false,\n        message: e.message\n      };\n    }\n  }\n  // Ensure change amounts go to correct destination\n  for (var i = 0; i < changeOutputs.length; i++) {\n    var output = changeOutputs[i];\n    try {\n      var outputInfo = exports.unpackOutput(output, systemId);\n      if (outputInfo.type !== templates.types.P2PKH && outputInfo.type !== templates.types.SMART_TRANSACTION) {\n        throw new Error(\"Cannot use non p2pkh/smarttx utxo type as change.\");\n      }\n      if (outputInfo.destinations.filter(function (x) {\n        return x !== changeAddr;\n      }).length !== 0) {\n        throw new Error(\"Some change destinations are not \" + changeAddr + \".\");\n      }\n      if (outputInfo.type === templates.types.SMART_TRANSACTION) {\n        if (outputInfo.params.length !== 1) throw new Error(\"Invalid param length for change smarttx\");\n        var master = outputInfo.master;\n        var param = outputInfo.params[0];\n        if (master.eval !== verus_typescript_primitives_1.EVALS.EVAL_NONE) {\n          throw new Error(\"Change smartx master must be EVAL_NONE\");\n        }\n        if (!((master.m === 0 && master.n === 0 || master.m === 1 && master.n === 1) && param.m === 1 && param.n === 1)) {\n          throw new Error(\"Multisig change unsupported\");\n        }\n        switch (param.eval) {\n          case verus_typescript_primitives_1.EVALS.EVAL_NONE:\n          case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT:\n            break;\n          default:\n            throw new Error(\"Change only supports EVAL_NONE and EVAL_RESERVE_OUTPUT smarttxs\");\n        }\n      }\n      for (var key in outputInfo.values) {\n        if (amountsOut[key] == null) amountsOut[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);else amountsOut[key] = amountsOut[key].add(outputInfo.values[key]);\n        if (amountChange[key] == null) amountChange[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);else amountChange[key] = amountChange[key].add(outputInfo.values[key]);\n      }\n    } catch (e) {\n      return {\n        valid: false,\n        message: e.message\n      };\n    }\n  }\n  var _in = {};\n  var _out = {};\n  var _change = {};\n  var _fees = {};\n  var _sent = {};\n  for (var key in amountsIn) {\n    _in[key] = amountsIn[key].toString();\n  }\n  for (var key in amountsOut) {\n    _out[key] = amountsOut[key].toString();\n  }\n  for (var key in amountsFee) {\n    _fees[key] = amountsFee[key].toString();\n  }\n  for (var key in amountChange) {\n    _change[key] = amountChange[key].toString();\n  }\n  for (var key in amountsIn) {\n    var outVal = amountsOut[key] != null ? amountsOut[key] : new bn_js_1.BN(0);\n    var feeVal = _fees[key] ? new bn_js_1.BN(_fees[key]) : new bn_js_1.BN(0);\n    _fees[key] = feeVal.add(amountsIn[key].sub(outVal)).toString();\n  }\n  for (var key in amountsIn) {\n    var changeVal = amountChange[key] != null ? amountChange[key] : new bn_js_1.BN(0);\n    var feeVal = _fees[key] ? new bn_js_1.BN(_fees[key]) : new bn_js_1.BN(0);\n    _sent[key] = amountsIn[key].sub(changeVal).sub(feeVal).toString();\n  }\n  return {\n    valid: true,\n    \"in\": _in,\n    out: _out,\n    change: _change,\n    fees: _fees,\n    sent: _sent\n  };\n};\nexports.validateFundedCurrencyTransfer = validateFundedCurrencyTransfer;\nvar createUnfundedCurrencyTransfer = function (systemId, outputs, network, expiryHeight, version, versionGroupId) {\n  if (expiryHeight === void 0) {\n    expiryHeight = 0;\n  }\n  if (version === void 0) {\n    version = 4;\n  }\n  if (versionGroupId === void 0) {\n    versionGroupId = 0x892f2085;\n  }\n  var txb = new TransactionBuilder(network);\n  txb.setVersion(version);\n  txb.setExpiryHeight(expiryHeight);\n  txb.setVersionGroupId(versionGroupId);\n  for (var _i = 0, outputs_1 = outputs; _i < outputs_1.length; _i++) {\n    var output = outputs_1[_i];\n    if (!output.currency) throw new Error(\"Must specify currency i-address for all outputs\");\n    if (output.satoshis == null) throw new Error(\"Must specify satoshis for all outputs\");\n    if (output.address == null) throw new Error(\"Must specify address for all outputs\");\n    var params = {\n      currency: output.currency,\n      satoshis: output.satoshis,\n      convertto: output.convertto ? output.convertto : output.currency,\n      exportto: output.exportto,\n      feecurrency: output.feecurrency ? output.feecurrency : systemId,\n      feesatoshis: output.feesatoshis ? output.feesatoshis : \"300000\",\n      via: output.via,\n      address: output.address,\n      refundto: output.refundto,\n      preconvert: !!output.preconvert,\n      burnweight: !!output.burnweight,\n      burn: !!output.burn,\n      mintnew: !!output.mintnew,\n      importtosource: !!output.importtosource,\n      bridgeid: output.bridgeid\n    };\n    // fee_currency_id?: string;\n    // fee_amount?: BigNumber;\n    // transfer_destination?: TransferDestination;\n    // dest_currency_id?: string;\n    // second_reserve_id?: string;\n    // dest_system_id?: string;\n    var isReserveTransfer = output.feecurrency != null || output.feesatoshis != null || output.convertto != null || output.exportto != null || output.via != null;\n    var satoshis = new bn_js_1.BN(params.satoshis, 10);\n    var values = new verus_typescript_primitives_1.CurrencyValueMap({\n      value_map: new Map([[params.currency, satoshis]]),\n      multivalue: false\n    });\n    var nativeFeeValue = params.feecurrency === systemId && isReserveTransfer ? new bn_js_1.BN(params.feesatoshis) : new bn_js_1.BN(0);\n    var nativeValue = params.currency === systemId ? satoshis.add(nativeFeeValue) : nativeFeeValue;\n    var isPKH = !isReserveTransfer && params.currency === systemId && params.address.type === verus_typescript_primitives_1.DEST_PKH;\n    if (isPKH) {\n      txb.addOutput(params.address.getAddressString(), nativeValue.toNumber());\n    } else {\n      var outMaster = void 0;\n      var outParams = void 0;\n      if (isReserveTransfer) {\n        var destination = new TxDestination(verus_typescript_primitives_1.RESERVE_TRANSFER_DESTINATION.type.toNumber(), verus_typescript_primitives_1.RESERVE_TRANSFER_DESTINATION.destination_bytes);\n        outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination]);\n        var flags = new bn_js_1.BN(1);\n        var version_1 = new bn_js_1.BN(1, 10);\n        var isConversion = params.convertto != null && params.convertto !== params.currency;\n        if (params.importtosource) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_IMPORT_TO_SOURCE);\n        if (params.via != null) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_RESERVE_TO_RESERVE);\n        if (params.exportto != null) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_CROSS_SYSTEM);\n        if (isConversion) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_CONVERT);\n        if (params.preconvert) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_PRECONVERT);\n        if (params.mintnew) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_MINT_CURRENCY);\n        if (params.burn) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_BURN_CHANGE_PRICE);\n        if (params.burnweight) flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_BURN_CHANGE_WEIGHT);\n        var ignoreBridgeId = isConversion || params.exportto == null;\n        if (!ignoreBridgeId && params.bridgeid == null) {\n          throw new Error(\"Bridge ID required\");\n        }\n        var resTransfer = new verus_typescript_primitives_1.ReserveTransfer({\n          values: values,\n          version: version_1,\n          flags: flags,\n          fee_currency_id: params.feecurrency,\n          fee_amount: new bn_js_1.BN(params.feesatoshis, 10),\n          transfer_destination: params.address,\n          dest_currency_id: output.via ? output.via : isConversion || params.exportto == null ? params.convertto : params.bridgeid,\n          second_reserve_id: params.convertto,\n          dest_system_id: params.exportto\n        });\n        outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_RESERVE_TRANSFER, 1, 1, [destination], [resTransfer.toBuffer()]);\n      } else {\n        values.value_map[\"delete\"](systemId);\n        if (values.value_map.size == 0) {\n          var destination = new TxDestination(params.address.type.toNumber(), params.address.destination_bytes);\n          // Assume token output\n          outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 0, 0, []);\n          outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination], []);\n        } else {\n          var destination = new TxDestination(params.address.type.toNumber(), params.address.destination_bytes);\n          // Assume token output\n          outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination]);\n          var version_2 = new bn_js_1.BN(1, 10);\n          var tokenOutput = new verus_typescript_primitives_1.TokenOutput({\n            values: values,\n            version: version_2\n          });\n          outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT, 1, 1, [destination], [tokenOutput.toBuffer()]);\n        }\n      }\n      var outputScript = script.compile([outMaster.toChunk(), opcodes.OP_CHECKCRYPTOCONDITION, outParams.toChunk(), opcodes.OP_DROP]);\n      txb.addOutput(outputScript, nativeValue.toNumber());\n    }\n  }\n  return txb.buildIncomplete().toHex();\n};\nexports.createUnfundedCurrencyTransfer = createUnfundedCurrencyTransfer;\nvar getFundedTxBuilder = function (fundedTxHex, network, prevOutScripts) {\n  var tx = Transaction.fromHex(fundedTxHex, network);\n  var inputs = tx.ins;\n  var txb = TransactionBuilder.fromTransaction(tx, network);\n  txb.inputs = [];\n  txb.tx.ins = [];\n  for (var i = 0; i < inputs.length; i++) {\n    var input = inputs[i];\n    var prevoutscript = prevOutScripts[i];\n    delete txb.prevTxMap[input.hash.toString('hex') + ':' + input.index];\n    txb.addInput(input.hash, input.index, input.sequence, prevoutscript);\n  }\n  return txb;\n};\nexports.getFundedTxBuilder = getFundedTxBuilder;","map":{"version":3,"names":["exports","__esModule","getFundedTxBuilder","createUnfundedCurrencyTransfer","validateFundedCurrencyTransfer","unpackOutput","verus_typescript_primitives_1","require","bn_js_1","Transaction","TransactionBuilder","TxDestination","script","opcodes","OptCCParams","templates","BNClass","BN","output","systemId","isInput","allowNonTransferEvals","_a","_b","outputScript","outputType","classifyOutput","values","fees","destinations","master","params","types","P2PK","add","value","P2PKH","destAddr","toBase58Check","pubKeyHash","decode","push","SMART_TRANSACTION","masterOptCC","paramsOptCC","decompiledScript","decompile","i","length","fromChunk","Error","processDestination_1","destination","destType","destinationBytes","includes","processOptCCParam","ccparam","data","ccvalues","ccfees","evalCode","EVALS","EVAL_NONE","vData","EVAL_STAKEGUARD","EVAL_RESERVE_TRANSFER","resTransfer","ReserveTransfer","fromBuffer","reserve_values","value_map","forEach","key","fee","fee_amount","feecurrency","fee_currency_id","transfer_destination","_i","_c","aux_dests","aux_dest","hasAuxDests","typeNoFlags","toNumber","destination_bytes","EVAL_RESERVE_OUTPUT","resOutput","TokenOutput","EVAL_IDENTITY_PRIMARY","id","Identity","version","eval","m","n","_d","paramsOptCC_1","paramsCc","processedParams","_e","_f","type","undefined","fundedTxHex","unfundedTxHex","changeAddr","network","utxoList","amountsIn","amountsOut","amountChange","amountsFee","fundedTx","fromHex","unfundedTx","fundedTxComparison","ins","valid","message","outs","changeOutputs","changeIndices","j","out","outScript","toString","filter","x","toHex","_loop_1","input","inputHash","Buffer","from","hash","reverse","inputUtxoIndex","findIndex","txid","outputIndex","index","inputUtxo","_script","_value","satoshis","inputInfo","e","state_1","outputInfo","param","_in","_out","_change","_fees","_sent","outVal","feeVal","sub","changeVal","change","sent","outputs","expiryHeight","versionGroupId","txb","setVersion","setExpiryHeight","setVersionGroupId","outputs_1","currency","address","convertto","exportto","feesatoshis","via","refundto","preconvert","burnweight","burn","mintnew","importtosource","bridgeid","isReserveTransfer","CurrencyValueMap","Map","multivalue","nativeFeeValue","nativeValue","isPKH","DEST_PKH","addOutput","getAddressString","outMaster","outParams","RESERVE_TRANSFER_DESTINATION","flags","version_1","isConversion","xor","RESERVE_TRANSFER_IMPORT_TO_SOURCE","RESERVE_TRANSFER_RESERVE_TO_RESERVE","RESERVE_TRANSFER_CROSS_SYSTEM","RESERVE_TRANSFER_CONVERT","RESERVE_TRANSFER_PRECONVERT","RESERVE_TRANSFER_MINT_CURRENCY","RESERVE_TRANSFER_BURN_CHANGE_PRICE","RESERVE_TRANSFER_BURN_CHANGE_WEIGHT","ignoreBridgeId","dest_currency_id","second_reserve_id","dest_system_id","toBuffer","size","version_2","tokenOutput","compile","toChunk","OP_CHECKCRYPTOCONDITION","OP_DROP","buildIncomplete","prevOutScripts","tx","inputs","fromTransaction","prevoutscript","prevTxMap","addInput","sequence"],"sources":["/Users/oddfl3x/Code/bridge2/NATI<>bridge_API_SWAP/node_modules/@bitgo/utxo-lib/dist/src/smart_transactions.js"],"sourcesContent":["\"use strict\";\nexports.__esModule = true;\nexports.getFundedTxBuilder = exports.createUnfundedCurrencyTransfer = exports.validateFundedCurrencyTransfer = exports.unpackOutput = void 0;\nvar verus_typescript_primitives_1 = require(\"verus-typescript-primitives\");\nvar bn_js_1 = require(\"bn.js\");\nvar Transaction = require('./transaction.js');\nvar TransactionBuilder = require('./transaction_builder.js');\nvar TxDestination = require('./tx_destination.js');\nvar script = require('./script.js');\nvar opcodes = require('bitcoin-ops');\nvar OptCCParams = require('./optccparams');\nvar templates = require('./templates');\n// Hack to force BigNumber to get typeof class instead of BN namespace\nvar BNClass = new bn_js_1.BN(0);\nvar unpackOutput = function (output, systemId, isInput, allowNonTransferEvals) {\n    var _a, _b;\n    if (isInput === void 0) { isInput = false; }\n    if (allowNonTransferEvals === void 0) { allowNonTransferEvals = false; }\n    // Verify change output\n    var outputScript = output.script;\n    var outputType = templates.classifyOutput(outputScript);\n    var values = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n    var fees = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n    var destinations = [];\n    var master;\n    var params = [];\n    if (outputType === templates.types.P2PK && isInput) {\n        values[systemId] = values[systemId].add(new bn_js_1.BN(output.value));\n    }\n    else if (outputType === templates.types.P2PKH) {\n        var destAddr = verus_typescript_primitives_1.toBase58Check(templates.pubKeyHash.output.decode(outputScript), 60);\n        values[systemId] = values[systemId].add(new bn_js_1.BN(output.value));\n        destinations.push(destAddr);\n    }\n    else if (outputType === templates.types.SMART_TRANSACTION) {\n        var masterOptCC = void 0;\n        var paramsOptCC = [];\n        var decompiledScript = script.decompile(outputScript);\n        for (var i = 0; i < decompiledScript.length; i += 2) {\n            if (i === 0)\n                masterOptCC = OptCCParams.fromChunk(decompiledScript[i]);\n            else\n                paramsOptCC.push(OptCCParams.fromChunk(decompiledScript[i]));\n        }\n        if (paramsOptCC.length > 1)\n            throw new Error(\">1 OptCCParam objects not currently supported for smart transaction params.\");\n        var processDestination_1 = function (destination) {\n            if (!(destination.destType === 1 && isInput) &&\n                destination.destType !== 2 &&\n                destination.destType !== 4) {\n                throw new Error(\"Unsupported destination type\");\n            }\n            var destAddr = verus_typescript_primitives_1.toBase58Check(destination.destinationBytes, destination.destType === 2 ? 60 : 102);\n            if (!destinations.includes(destAddr)) {\n                destinations.push(destAddr);\n            }\n        };\n        var processOptCCParam = function (ccparam) {\n            var _a, _b;\n            var data;\n            var ccvalues = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n            var ccfees = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n            switch (ccparam.evalCode) {\n                case verus_typescript_primitives_1.EVALS.EVAL_NONE:\n                    if (ccparam.vData.length !== 0) {\n                        throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n                    }\n                    ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n                    break;\n                case verus_typescript_primitives_1.EVALS.EVAL_STAKEGUARD:\n                    if (!isInput) {\n                        throw new Error(\"Cannot create stakeguard output.\");\n                    }\n                    ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n                    break;\n                case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_TRANSFER:\n                    if (ccparam.vData.length !== 1) {\n                        throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n                    }\n                    var resTransfer = new verus_typescript_primitives_1.ReserveTransfer();\n                    resTransfer.fromBuffer(ccparam.vData[0]);\n                    ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n                    resTransfer.reserve_values.value_map.forEach(function (value, key) {\n                        if (key !== systemId) {\n                            if (!ccvalues[key])\n                                ccvalues[key] = value;\n                            else\n                                ccvalues[key] = ccvalues[key].add(value);\n                        }\n                    });\n                    data = resTransfer;\n                    var fee = resTransfer.fee_amount;\n                    var feecurrency = resTransfer.fee_currency_id;\n                    ccfees[feecurrency] = fee;\n                    if (resTransfer.transfer_destination.fees != null) {\n                        ccfees[feecurrency] = ccfees[feecurrency].add(resTransfer.transfer_destination.fees);\n                    }\n                    for (var _i = 0, _c = resTransfer.transfer_destination.aux_dests; _i < _c.length; _i++) {\n                        var aux_dest = _c[_i];\n                        if (aux_dest.hasAuxDests()) {\n                            throw new Error(\"Nested aux destinations not supported\");\n                        }\n                        if (aux_dest.fees != null) {\n                            ccfees[feecurrency] = ccfees[feecurrency].add(aux_dest.fees);\n                        }\n                        processDestination_1({\n                            destType: aux_dest.typeNoFlags().toNumber(),\n                            destinationBytes: aux_dest.destination_bytes\n                        });\n                    }\n                    break;\n                case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT:\n                    if (ccparam.vData.length !== 1) {\n                        throw new Error(\"Unexpected length of vdata array for eval code \" + ccparam.evalCode);\n                    }\n                    var resOutput = new verus_typescript_primitives_1.TokenOutput();\n                    resOutput.fromBuffer(ccparam.vData[0]);\n                    ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n                    resOutput.reserve_values.value_map.forEach(function (value, key) {\n                        if (key !== systemId) {\n                            if (!ccvalues[key])\n                                ccvalues[key] = value;\n                            else\n                                ccvalues[key] = ccvalues[key].add(value);\n                        }\n                    });\n                    data = resOutput;\n                    break;\n                case verus_typescript_primitives_1.EVALS.EVAL_IDENTITY_PRIMARY:\n                    if (allowNonTransferEvals) {\n                        ccvalues[systemId] = ccvalues[systemId].add(new bn_js_1.BN(output.value));\n                        var id = new verus_typescript_primitives_1.Identity();\n                        id.fromBuffer(ccparam.vData[0]);\n                        data = id;\n                    }\n                    else {\n                        throw new Error('EVAL_IDENTITY_PRIMARY not permitted in this context.');\n                    }\n                    break;\n                default:\n                    throw new Error(\"Unsupported eval code \" + ccparam.evalCode);\n            }\n            return {\n                version: ccparam.version,\n                eval: ccparam.evalCode,\n                m: ccparam.m,\n                n: ccparam.n,\n                data: data,\n                values: ccvalues,\n                fees: ccfees\n            };\n        };\n        master = processOptCCParam(masterOptCC);\n        for (var _i = 0, _c = masterOptCC.destinations; _i < _c.length; _i++) {\n            var destination = _c[_i];\n            processDestination_1(destination);\n        }\n        for (var _d = 0, paramsOptCC_1 = paramsOptCC; _d < paramsOptCC_1.length; _d++) {\n            var paramsCc = paramsOptCC_1[_d];\n            var processedParams = processOptCCParam(paramsCc);\n            params.push(processedParams);\n            for (var key in processedParams.values) {\n                var value = processedParams.values[key];\n                if (!values[key])\n                    values[key] = value;\n                else\n                    values[key] = values[key].add(value);\n            }\n            for (var key in processedParams.fees) {\n                var fee = processedParams.fees[key];\n                if (!fees[key])\n                    fees[key] = fee;\n                else\n                    fees[key] = fees[key].add(fee);\n            }\n            for (var _e = 0, _f = paramsCc.destinations; _e < _f.length; _e++) {\n                var destination = _f[_e];\n                processDestination_1(destination);\n            }\n        }\n    }\n    else {\n        throw new Error(\"Unsupported output type \" + outputType);\n    }\n    return {\n        destinations: destinations,\n        values: values,\n        fees: fees,\n        type: outputType,\n        master: master,\n        params: params.length > 0 ? params : undefined\n    };\n};\nexports.unpackOutput = unpackOutput;\nvar validateFundedCurrencyTransfer = function (systemId, fundedTxHex, unfundedTxHex, changeAddr, network, utxoList) {\n    var _a, _b, _c, _d;\n    var amountsIn = (_a = {}, _a[systemId] = new bn_js_1.BN(0), _a);\n    var amountsOut = (_b = {}, _b[systemId] = new bn_js_1.BN(0), _b);\n    var amountChange = (_c = {}, _c[systemId] = new bn_js_1.BN(0), _c);\n    var amountsFee = (_d = {}, _d[systemId] = new bn_js_1.BN(0), _d);\n    var fundedTx = Transaction.fromHex(fundedTxHex, network);\n    var unfundedTx = Transaction.fromHex(unfundedTxHex, network);\n    var fundedTxComparison = Transaction.fromHex(fundedTxHex, network);\n    if (!fundedTxComparison.ins.length) {\n        return {\n            valid: false,\n            message: \"Transaction has \" + fundedTxComparison.ins.length + \" inputs.\"\n        };\n    }\n    fundedTxComparison.ins = [];\n    fundedTx.outs = fundedTx.outs;\n    unfundedTx.outs = unfundedTx.outs;\n    fundedTxComparison.outs = fundedTxComparison.outs;\n    fundedTx.ins = fundedTx.ins;\n    unfundedTx.ins = unfundedTx.ins;\n    fundedTxComparison.ins = fundedTxComparison.ins;\n    var changeOutputs = [];\n    var changeIndices = [];\n    if (!fundedTxComparison.outs.length) {\n        return {\n            valid: false,\n            message: \"Transaction has \" + fundedTxComparison.outs.length + \" outputs.\"\n        };\n    }\n    // Find all change outputs\n    for (var i = 0, j = 0; i < fundedTxComparison.outs.length; i++, j++) {\n        var out = fundedTxComparison.outs[i];\n        var outScript = out.script.toString('hex');\n        if (unfundedTx.outs[j] != null &&\n            outScript === unfundedTx.outs[j].script.toString('hex') &&\n            out.value === unfundedTx.outs[j].value) {\n            continue;\n        }\n        else {\n            changeOutputs.push(out);\n            changeIndices.push(i);\n            j--;\n        }\n    }\n    // Filter change outputs from tx comparison\n    fundedTxComparison.outs = fundedTxComparison.outs.filter(function (x, i) {\n        return !changeIndices.includes(i);\n    });\n    // Verify funded tx and unfunded tx are the same where \n    // they should be the same\n    if (fundedTxComparison.toHex() !== unfundedTx.toHex()) {\n        return {\n            valid: false,\n            message: \"Transaction hex does not match unfunded component.\"\n        };\n    }\n    var _loop_1 = function (input) {\n        var inputHash = Buffer.from(input.hash).reverse().toString('hex');\n        var inputUtxoIndex = utxoList.findIndex(function (x) { return ((x.txid === inputHash) && x.outputIndex === input.index); });\n        if (inputUtxoIndex < 0) {\n            return { value: {\n                    valid: false,\n                    message: \"Cannot find corresponding input for \" + inputHash + \" index \" + input.index + \".\"\n                } };\n        }\n        var inputUtxo = utxoList[inputUtxoIndex];\n        var _script = Buffer.from(inputUtxo.script, 'hex');\n        var _value = inputUtxo.satoshis;\n        try {\n            var inputInfo = exports.unpackOutput({ value: _value, script: _script }, systemId, true);\n            for (var key in inputInfo.values) {\n                if (amountsIn[key] == null) {\n                    amountsIn[key] = new bn_js_1.BN(inputInfo.values[key] != null ? inputInfo.values[key] : 0);\n                }\n                else\n                    amountsIn[key] = amountsIn[key].add(inputInfo.values[key]);\n            }\n        }\n        catch (e) {\n            return { value: {\n                    valid: false,\n                    message: e.message\n                } };\n        }\n    };\n    // Verify all inputs are correct and count their amounts\n    for (var _i = 0, _e = fundedTx.ins; _i < _e.length; _i++) {\n        var input = _e[_i];\n        var state_1 = _loop_1(input);\n        if (typeof state_1 === \"object\")\n            return state_1.value;\n    }\n    // Count output amounts (trusted more than input because we verify that they match\n    // the outputs submitted in the unfunded transaction)\n    for (var i = 0; i < unfundedTx.outs.length; i++) {\n        var output = unfundedTx.outs[i];\n        try {\n            var outputInfo = exports.unpackOutput(output, systemId, false, true);\n            for (var key in outputInfo.values) {\n                if (amountsOut[key] == null) {\n                    amountsOut[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);\n                }\n                else\n                    amountsOut[key] = amountsOut[key].add(outputInfo.values[key]);\n            }\n            for (var key in outputInfo.fees) {\n                if (amountsFee[key] == null) {\n                    amountsFee[key] = new bn_js_1.BN(outputInfo.fees[key] != null ? outputInfo.fees[key] : 0);\n                }\n                else\n                    amountsFee[key] = amountsFee[key].add(outputInfo.fees[key]);\n            }\n        }\n        catch (e) {\n            return {\n                valid: false,\n                message: e.message\n            };\n        }\n    }\n    // Ensure change amounts go to correct destination\n    for (var i = 0; i < changeOutputs.length; i++) {\n        var output = changeOutputs[i];\n        try {\n            var outputInfo = exports.unpackOutput(output, systemId);\n            if (outputInfo.type !== templates.types.P2PKH && outputInfo.type !== templates.types.SMART_TRANSACTION) {\n                throw new Error(\"Cannot use non p2pkh/smarttx utxo type as change.\");\n            }\n            if (outputInfo.destinations.filter(function (x) { return x !== changeAddr; }).length !== 0) {\n                throw new Error(\"Some change destinations are not \" + changeAddr + \".\");\n            }\n            if (outputInfo.type === templates.types.SMART_TRANSACTION) {\n                if (outputInfo.params.length !== 1)\n                    throw new Error(\"Invalid param length for change smarttx\");\n                var master = outputInfo.master;\n                var param = outputInfo.params[0];\n                if (master.eval !== verus_typescript_primitives_1.EVALS.EVAL_NONE) {\n                    throw new Error(\"Change smartx master must be EVAL_NONE\");\n                }\n                if (!((master.m === 0 && master.n === 0 || master.m === 1 && master.n === 1) &&\n                    param.m === 1 && param.n === 1)) {\n                    throw new Error(\"Multisig change unsupported\");\n                }\n                switch (param.eval) {\n                    case verus_typescript_primitives_1.EVALS.EVAL_NONE:\n                    case verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT:\n                        break;\n                    default:\n                        throw new Error(\"Change only supports EVAL_NONE and EVAL_RESERVE_OUTPUT smarttxs\");\n                }\n            }\n            for (var key in outputInfo.values) {\n                if (amountsOut[key] == null)\n                    amountsOut[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);\n                else\n                    amountsOut[key] = amountsOut[key].add(outputInfo.values[key]);\n                if (amountChange[key] == null)\n                    amountChange[key] = new bn_js_1.BN(outputInfo.values[key] != null ? outputInfo.values[key] : 0);\n                else\n                    amountChange[key] = amountChange[key].add(outputInfo.values[key]);\n            }\n        }\n        catch (e) {\n            return {\n                valid: false,\n                message: e.message\n            };\n        }\n    }\n    var _in = {};\n    var _out = {};\n    var _change = {};\n    var _fees = {};\n    var _sent = {};\n    for (var key in amountsIn) {\n        _in[key] = amountsIn[key].toString();\n    }\n    for (var key in amountsOut) {\n        _out[key] = amountsOut[key].toString();\n    }\n    for (var key in amountsFee) {\n        _fees[key] = amountsFee[key].toString();\n    }\n    for (var key in amountChange) {\n        _change[key] = amountChange[key].toString();\n    }\n    for (var key in amountsIn) {\n        var outVal = amountsOut[key] != null ? amountsOut[key] : new bn_js_1.BN(0);\n        var feeVal = _fees[key] ? new bn_js_1.BN(_fees[key]) : new bn_js_1.BN(0);\n        _fees[key] = (feeVal.add((amountsIn[key].sub(outVal)))).toString();\n    }\n    for (var key in amountsIn) {\n        var changeVal = amountChange[key] != null ? amountChange[key] : new bn_js_1.BN(0);\n        var feeVal = _fees[key] ? new bn_js_1.BN(_fees[key]) : new bn_js_1.BN(0);\n        _sent[key] = (amountsIn[key].sub(changeVal).sub(feeVal)).toString();\n    }\n    return { valid: true, \"in\": _in, out: _out, change: _change, fees: _fees, sent: _sent };\n};\nexports.validateFundedCurrencyTransfer = validateFundedCurrencyTransfer;\nvar createUnfundedCurrencyTransfer = function (systemId, outputs, network, expiryHeight, version, versionGroupId) {\n    if (expiryHeight === void 0) { expiryHeight = 0; }\n    if (version === void 0) { version = 4; }\n    if (versionGroupId === void 0) { versionGroupId = 0x892f2085; }\n    var txb = new TransactionBuilder(network);\n    txb.setVersion(version);\n    txb.setExpiryHeight(expiryHeight);\n    txb.setVersionGroupId(versionGroupId);\n    for (var _i = 0, outputs_1 = outputs; _i < outputs_1.length; _i++) {\n        var output = outputs_1[_i];\n        if (!output.currency)\n            throw new Error(\"Must specify currency i-address for all outputs\");\n        if (output.satoshis == null)\n            throw new Error(\"Must specify satoshis for all outputs\");\n        if (output.address == null)\n            throw new Error(\"Must specify address for all outputs\");\n        var params = {\n            currency: output.currency,\n            satoshis: output.satoshis,\n            convertto: output.convertto ? output.convertto : output.currency,\n            exportto: output.exportto,\n            feecurrency: output.feecurrency ? output.feecurrency : systemId,\n            feesatoshis: output.feesatoshis ? output.feesatoshis : \"300000\",\n            via: output.via,\n            address: output.address,\n            refundto: output.refundto,\n            preconvert: !!(output.preconvert),\n            burnweight: !!(output.burnweight),\n            burn: !!(output.burn),\n            mintnew: !!(output.mintnew),\n            importtosource: !!(output.importtosource),\n            bridgeid: output.bridgeid\n        };\n        // fee_currency_id?: string;\n        // fee_amount?: BigNumber;\n        // transfer_destination?: TransferDestination;\n        // dest_currency_id?: string;\n        // second_reserve_id?: string;\n        // dest_system_id?: string;\n        var isReserveTransfer = output.feecurrency != null ||\n            output.feesatoshis != null ||\n            output.convertto != null ||\n            output.exportto != null ||\n            output.via != null;\n        var satoshis = new bn_js_1.BN(params.satoshis, 10);\n        var values = new verus_typescript_primitives_1.CurrencyValueMap({\n            value_map: new Map([[params.currency, satoshis]]),\n            multivalue: false\n        });\n        var nativeFeeValue = params.feecurrency === systemId && isReserveTransfer ? new bn_js_1.BN(params.feesatoshis) : new bn_js_1.BN(0);\n        var nativeValue = params.currency === systemId ? satoshis.add(nativeFeeValue) : nativeFeeValue;\n        var isPKH = !isReserveTransfer && params.currency === systemId && params.address.type === verus_typescript_primitives_1.DEST_PKH;\n        if (isPKH) {\n            txb.addOutput(params.address.getAddressString(), nativeValue.toNumber());\n        }\n        else {\n            var outMaster = void 0;\n            var outParams = void 0;\n            if (isReserveTransfer) {\n                var destination = new TxDestination(verus_typescript_primitives_1.RESERVE_TRANSFER_DESTINATION.type.toNumber(), verus_typescript_primitives_1.RESERVE_TRANSFER_DESTINATION.destination_bytes);\n                outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination]);\n                var flags = new bn_js_1.BN(1);\n                var version_1 = new bn_js_1.BN(1, 10);\n                var isConversion = params.convertto != null && params.convertto !== params.currency;\n                if (params.importtosource)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_IMPORT_TO_SOURCE);\n                if (params.via != null)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_RESERVE_TO_RESERVE);\n                if (params.exportto != null)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_CROSS_SYSTEM);\n                if (isConversion)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_CONVERT);\n                if (params.preconvert)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_PRECONVERT);\n                if (params.mintnew)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_MINT_CURRENCY);\n                if (params.burn)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_BURN_CHANGE_PRICE);\n                if (params.burnweight)\n                    flags = flags.xor(verus_typescript_primitives_1.RESERVE_TRANSFER_BURN_CHANGE_WEIGHT);\n                var ignoreBridgeId = (isConversion || params.exportto == null);\n                if (!ignoreBridgeId && params.bridgeid == null) {\n                    throw new Error(\"Bridge ID required\");\n                }\n                var resTransfer = new verus_typescript_primitives_1.ReserveTransfer({\n                    values: values,\n                    version: version_1,\n                    flags: flags,\n                    fee_currency_id: params.feecurrency,\n                    fee_amount: new bn_js_1.BN(params.feesatoshis, 10),\n                    transfer_destination: params.address,\n                    dest_currency_id: output.via ? output.via\n                        :\n                            (isConversion || params.exportto == null) ? params.convertto : params.bridgeid,\n                    second_reserve_id: params.convertto,\n                    dest_system_id: params.exportto\n                });\n                outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_RESERVE_TRANSFER, 1, 1, [destination], [resTransfer.toBuffer()]);\n            }\n            else {\n                values.value_map[\"delete\"](systemId);\n                if (values.value_map.size == 0) {\n                    var destination = new TxDestination(params.address.type.toNumber(), params.address.destination_bytes);\n                    // Assume token output\n                    outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 0, 0, []);\n                    outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination], []);\n                }\n                else {\n                    var destination = new TxDestination(params.address.type.toNumber(), params.address.destination_bytes);\n                    // Assume token output\n                    outMaster = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_NONE, 1, 1, [destination]);\n                    var version_2 = new bn_js_1.BN(1, 10);\n                    var tokenOutput = new verus_typescript_primitives_1.TokenOutput({\n                        values: values,\n                        version: version_2\n                    });\n                    outParams = new OptCCParams(3, verus_typescript_primitives_1.EVALS.EVAL_RESERVE_OUTPUT, 1, 1, [destination], [tokenOutput.toBuffer()]);\n                }\n            }\n            var outputScript = script.compile([\n                outMaster.toChunk(),\n                opcodes.OP_CHECKCRYPTOCONDITION,\n                outParams.toChunk(),\n                opcodes.OP_DROP,\n            ]);\n            txb.addOutput(outputScript, nativeValue.toNumber());\n        }\n    }\n    return txb.buildIncomplete().toHex();\n};\nexports.createUnfundedCurrencyTransfer = createUnfundedCurrencyTransfer;\nvar getFundedTxBuilder = function (fundedTxHex, network, prevOutScripts) {\n    var tx = Transaction.fromHex(fundedTxHex, network);\n    var inputs = tx.ins;\n    var txb = TransactionBuilder.fromTransaction(tx, network);\n    txb.inputs = [];\n    txb.tx.ins = [];\n    for (var i = 0; i < inputs.length; i++) {\n        var input = inputs[i];\n        var prevoutscript = prevOutScripts[i];\n        delete txb.prevTxMap[input.hash.toString('hex') + ':' + input.index];\n        txb.addInput(input.hash, input.index, input.sequence, prevoutscript);\n    }\n    return txb;\n};\nexports.getFundedTxBuilder = getFundedTxBuilder;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}